<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureStream Pro | Login</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #0c2461, #1e3799); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-container { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; width: 100%; max-width: 450px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .logo-section { text-align: center; margin-bottom: 30px; }
        .logo-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #00b7ff, #0066ff); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 36px; color: white; }
        h1 { color: white; font-size: 28px; margin-bottom: 8px; }
        p { color: #a0cfff; font-size: 14px; }
        .message-box { padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; animation: fadeIn 0.3s ease; }
        .message-box.success { background: rgba(46,204,113,0.2); border-left: 4px solid #2ecc71; color: #2ecc71; }
        .message-box.error { background: rgba(231,76,60,0.2); border-left: 4px solid #e74c3c; color: #e74c3c; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; color: #a0cfff; margin-bottom: 8px; font-size: 14px; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper i:first-child { position: absolute; left: 15px; color: #00b7ff; font-size: 18px; }
        .login-input { width: 100%; padding: 15px 15px 15px 50px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 16px; }
        .login-input:focus { outline: none; border-color: #00b7ff; }
        .btn-login { width: 100%; padding: 16px; background: linear-gradient(135deg, #00b7ff, #0066ff); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        .btn-login:hover { background: linear-gradient(135deg, #00a3e6, #0052cc); }
        .user-info { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 20px; margin-top: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .user-info h3 { color: white; font-size: 16px; margin-bottom: 15px; }
        .user-info ul { list-style: none; }
        .user-info li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: #a0cfff; font-size: 14px; }
        .footer { text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); color: #a0cfff; font-size: 14px; }
        .loading { display: none; text-align: center; margin: 20px 0; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #00b7ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo-section">
            <div class="logo-icon">üîí</div>
            <h1>SecureStream Pro</h1>
            <p>Sistema de Sesi√≥n √önica</p>
        </div>
        
        <div class="message-box" id="messageBox"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Verificando...</p>
        </div>
        
        <div id="loginForm">
            <div class="input-group">
                <label class="input-label">Usuario</label>
                <div class="input-wrapper">
                    <i>üë§</i>
                    <input type="text" id="username" class="login-input" placeholder="admin" value="admin">
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Contrase√±a</label>
                <div class="input-wrapper">
                    <i>üîí</i>
                    <input type="password" id="password" class="login-input" placeholder="admin123" value="admin123">
                </div>
            </div>
            
            <button class="btn-login" id="loginBtn">
                <span>üîë INICIAR SESI√ìN</span>
            </button>
        </div>
        
        <div class="user-info">
            <h3>Credenciales de Prueba</h3>
            <ul>
                <li><span>Administrador:</span> <span style="color: #00b7ff;">admin / admin123</span></li>
                <li><span>Usuario normal:</span> <span style="color: #00ff88;">usuario / user123</span></li>
                <li><span>Duraci√≥n:</span> <span style="color: #ffaa00;">60 minutos por sesi√≥n</span></li>
            </ul>
        </div>
        
        <div class="footer">
            <p>SecureStream Pro v3.0 | Sesi√≥n √önica</p>
            <p>GitHub Pages Edition</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/auth-simple.js"></script>
    <script>
        // ============================================
        // CONFIGURACI√ìN INICIAL - SIN BUCLE INFINITO
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Login page cargada');
            
            // IMPORTANTE: NO VERIFICAR SESI√ìN AUTOM√ÅTICAMENTE AL CARGAR
            // Esto evita el bucle infinito
            
            // En su lugar, mostrar mensaje si hay sesi√≥n previa
            const sessionStr = localStorage.getItem('secure_stream_session');
            if (sessionStr) {
                try {
                    const session = JSON.parse(sessionStr);
                    console.log('üì± Sesi√≥n previa encontrada para:', session.user?.username);
                    
                    // Mostrar mensaje informativo pero NO redirigir autom√°ticamente
                    showMessage('info', 
                        `üëã Hola ${session.user?.name || session.user?.username}.<br>
                        Ya tienes una sesi√≥n activa.<br>
                        Puedes iniciar sesi√≥n nuevamente o <a href="#" onclick="clearSession()" style="color:#00b7ff;">cerrar sesi√≥n</a>.`
                    );
                } catch (e) {
                    console.log('‚ö†Ô∏è Sesi√≥n corrupta');
                }
            }
            
            // Configurar eventos del formulario
            const loginBtn = document.getElementById('loginBtn');
            const passwordInput = document.getElementById('password');
            
            loginBtn.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Enfocar campo de usuario
            document.getElementById('username').focus();
        });
        
        // ============================================
        // MANEJADOR DE LOGIN
        // ============================================
        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('error', 'Completa todos los campos');
                return;
            }
            
            // Mostrar loading
            showLoading('Verificando credenciales...');
            
            try {
                const result = await SecureAuth.login(username, password);
                
                hideLoading();
                
                if (result.success) {
                    showMessage('success', `‚úÖ ¬°Bienvenido ${result.user.name}!`);
                    
                    // DEBUG: Mostrar informaci√≥n de la sesi√≥n
                    console.log('üéâ Login exitoso');
                    debugAuth(); // Mostrar informaci√≥n de debug
                    
                    // Esperar 1.5 segundos y redirigir
                    setTimeout(() => {
                        if (result.user.user_type === 'admin') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'dashboard.html';
                        }
                    }, 1500);
                    
                } else {
                    showMessage('error', '‚ùå ' + result.error);
                }
                
            } catch (error) {
                hideLoading();
                showMessage('error', '‚ùå Error de conexi√≥n');
                console.error('Login error:', error);
            }
        }
        
        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loginBtn').disabled = true;
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('loginBtn').disabled = false;
        }
        
        function showMessage(type, text) {
            const messageBox = document.getElementById('messageBox');
            messageBox.className = `message-box ${type}`;
            messageBox.innerHTML = text;
            messageBox.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 8000);
            }
        }
        
        function clearSession() {
            if (confirm('¬øCerrar sesi√≥n actual?')) {
                SecureAuth.clearSession();
                showMessage('success', '‚úÖ Sesi√≥n cerrada. Ahora puedes iniciar sesi√≥n nuevamente.');
                setTimeout(() => location.reload(), 1000);
            }
        }
        
        // Hacer disponible globalmente
        window.clearSession = clearSession;
        window.debugAuth = debugAuth;
    </script>
</body>
</html>
